<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.idcq.appserver.dto.order.OrderShopRsrcDto" >
  <resultMap id="BaseResultMap" type="com.idcq.appserver.dto.order.OrderShopRsrcDto" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Mar 25 16:09:20 CST 2015.
    -->
    <id column="order_resource_id" property="orderResourceId" jdbcType="BIGINT" />
    <result column="order_id" property="orderId" jdbcType="VARCHAR" />
    <result column="shop_id" property="shopId" jdbcType="INTEGER" />
    <result column="min_people" property="minPeople" jdbcType="INTEGER" />
    <result column="max_people" property="maxPeople" jdbcType="INTEGER" />
    <!-- 
    <result column="group_id" property="groupId" jdbcType="INTEGER" />
     -->
    <result column="inteval_id" property="intevalId" jdbcType="INTEGER" />
    <result column="resource_number" property="resourceNumber" jdbcType="INTEGER" />
    <result column="reserve_resource_date" property="reserveResourceDate" jdbcType="DATE" />
    <result column="create_time" property="createTime" jdbcType="TIMESTAMP" />
    <result column="status" property="status" />
    
    <result column="book_rule_id" property="bookRuleId" />
    
    <result column="user_id" property="userId" />
    <result column="username" property="userName" />
    <result column="mobile" property="mobile" />
    <result column="start_time" property="startTime" />
    <result column="end_time" property="endTime" />
    <result column="resource_type" property="resourceType" />
    <result column="consumer_num" property="pNum" jdbcType="INTEGER"/>
    <result column="biz_id" property="bizId" jdbcType="INTEGER"/>
    <result column="biz_name" property="bizName" />
    
   
  </resultMap>
  <sql id="Base_Column_List" >
    order_resource_id, order_id, shop_id, book_rule_id, inteval_id, resource_number, reserve_resource_date, 
    create_time,status
  </sql>
  <sql id="Base_Column_List2" >
    order_resource_id, order_id, shop_id, book_rule_id, inteval_id, resource_number, reserve_resource_date, 
    create_time,status,start_time,end_time
  </sql>
  <select id="getResourceByOrderId" parameterType="java.lang.String" resultType="java.util.Map">
  	select resource_type as resourceType, biz_id as bizId from 1dcq_order_shop_resource where order_id = #{orderId} limit 1
  </select>
  <select id="getResourceTypeByOrderId" parameterType="java.lang.String" resultType="java.lang.String">
  	select resource_type from 1dcq_order_shop_resource where order_id = #{orderId} limit 1
  </select>
  <update id="updateStatusByOrderId" parameterType="java.util.Map">
  	update 1dcq_order_shop_resource set status = #{status} where order_id = #{orderId}
  </update>
  
  <update id="updateStatusByOrderIdList" parameterType="java.util.Map">
  	update 1dcq_order_shop_resource set status = #{status} where order_id in
  	<foreach collection="orderIdList" item="item" open="(" close=")" separator=",">
  			#{item}
  	</foreach>
  </update>
  <select id="getOrderShopRsrcCount" parameterType="java.lang.String" resultType="java.lang.Integer">
  	select count(1) from 1dcq_order_shop_resource where order_id = #{orderId}
  </select>
  <!-- 根据订单编号查询丽人类技师编号 -->
  <select id="getTechIdByOrderId" parameterType="java.util.Map" resultType="java.lang.Long">
    <![CDATA[
		SELECT
			st.technician_id AS techId
		FROM
			1dcq_shop_technician st
		INNER JOIN 1dcq_order_shop_resource osr ON osr.biz_id = st.technician_id
		INNER JOIN 1dcq_order o ON osr.order_id = o.order_id
		WHERE
			osr.order_id = #{orderId}
		AND osr.resource_type = #{resourceType}
		AND osr.biz_id IS NOT NULL
		AND st.work_status <> 3
	]]>
  </select>
  <!-- 查询当前技师是否还有处于服务中的订单（订单状态：1,4） -->
  <select id="getTechServerOrderSrc" parameterType="java.util.Map" resultType="java.lang.Integer">
      <![CDATA[
      SELECT
			COUNT(1)
		FROM
			1dcq_order o
		INNER JOIN 1dcq_order_shop_resource osr ON osr.order_id = o.order_id
		WHERE
			osr.biz_id = #{techId}
		AND osr.resource_type = #{resourceType}
		AND o.order_status in (1,4)
		AND o.order_id <> #{orderId}
	]]>
  </select>
  <!-- 查询订单预定资源 -->
  <select id="queryOrderShopResource" resultType="java.util.Map" parameterType="java.util.Map">
  	<![CDATA[
	  	SELECT
	  		osr.order_resource_id,
			osr.order_id,
			osr.reserve_resource_date,
			osr.start_time,
			s.shop_name,
			o.user_id
		FROM
			1dcq_order_shop_resource osr
		INNER JOIN 1dcq_order o ON osr.order_id = o.order_id
		LEFT JOIN 1dcq_shop s on o.shop_id = s.shop_id
		WHERE
			o.order_status = 0
		AND (osr.`status` = 1 or osr.`status` is null)
		AND osr.remind_status = 0
		AND osr.reserve_resource_date = #{date}
		AND osr.start_time <= #{time}
		LIMIT #{startNo},#{pSize}
	]]>
  </select>
  <update id="batchUpdateOrderShopResource" parameterType="java.util.List">
  	UPDATE 1dcq_order_shop_resource osr
		SET osr.remind_status = 1
		WHERE
			osr.order_resource_id IN 
			<foreach collection="list" item="osr" close=")" open="(" separator=",">
				#{osr.order_resource_id}
			</foreach>
  </update>
  <select id="getOrderShopRsrcLimitOne" resultMap="BaseResultMap" parameterType="java.lang.String">
  	select 
  	<include refid="Base_Column_List2" />
  	from 1dcq_order_shop_resource
  	where order_id = #{orderId} limit 1
  </select>
  <select id="queryRsrcGroupNumOfUsed" parameterType="java.util.Map" resultType="java.lang.Long">
  	select SUM(ifnull(resource_number,0)) 
  	from 1dcq_order_shop_resource
  	where shop_id = #{shopId}
  	and group_id = #{groupId}
  	and inteval_id = #{intevalId}
  </select>
  <select id="queryRsrcGroupNumOfUsed2" parameterType="java.util.Map" resultType="java.lang.Long">
  	select SUM(ifnull(resource_number,0)) 
  	from 1dcq_order_shop_resource
  	where book_rule_id = #{bookRuleId}
  	and reserve_resource_date = #{reserveDate}
  	and inteval_id = #{intevalId}
  </select>
  <select id="getOrderGroupByshopId" resultMap="BaseResultMap" parameterType="java.util.Map" >
    select shop_id,book_rule_id,inteval_id,sum(resource_number) resource_number
    from 1dcq_order_shop_resource
    where 1=1
    <if test="shopId != null" >
      and shop_id=#{shopId}
    </if>
    <if test="queryDate != null" >
      and reserve_resource_date=#{queryDate}
    </if>
    <if test="bookRuleId != null" >
      and book_rule_id=#{bookRuleId}
    </if>
    <if test="intevalId != null" >
      and inteval_id=#{intevalId}
    </if>
    group by book_rule_id,inteval_id
  </select>
  <select id="getOrderGroupsByOrderId" resultMap="BaseResultMap" parameterType="java.lang.String" >
    select 
    <include refid="Base_Column_List" />
    from 1dcq_order_shop_resource
    where order_id = #{orderId}
  </select>
  <delete id="delOrderShopRsrc" parameterType="java.lang.String" >
    delete from 1dcq_order_shop_resource
    where order_id = #{orderId}
  </delete>
  <update id="enableOrderShopRsrc" parameterType="java.lang.String">
  	update 1dcq_order_shop_resource set status = 1 where order_id = #{orderId}
  </update>
  <insert id="saveOrderShopRsrc" parameterType="com.idcq.appserver.dto.order.OrderShopRsrcDto" >
    insert into 1dcq_order_shop_resource
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="orderResourceId != null" >
        order_resource_id,
      </if>
      <if test="orderId != null" >
        order_id,
      </if>
      <if test="shopId != null" >
        shop_id,
      </if>
      <if test="bookRuleId != null" >
        book_rule_id,
      </if>
      <if test="intevalId != null" >
        inteval_id,
      </if>
      <if test="resourceNumber != null" >
        resource_number,
      </if>
      <if test="reserveResourceDate != null" >
        reserve_resource_date,
      </if>
      <if test="createTime != null" >
        create_time,
      </if>
      <if test="status != null" >
        status,
      </if>
      
      <if test="userId != null" >
        user_id,
      </if>
      <if test="userName != null" >
        username,
      </if>
      <if test="mobile != null" >
        mobile,
      </if>
      <if test="startTime != null" >
        start_time,
      </if>
      <if test="endTime != null" >
        end_time,
      </if>
      <if test="resourceType != null" >
        resource_type,
      </if>
      <if test="minPeople != null" >
        min_people,
      </if>
      <if test="maxPeople != null" >
        max_people,
      </if>
      <if test="bizId != null" >
        biz_id,
      </if>
      <if test="bizName != null" >
        biz_name,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="orderResourceId != null" >
        #{orderResourceId,jdbcType=BIGINT},
      </if>
      <if test="orderId != null" >
        #{orderId,jdbcType=VARCHAR},
      </if>
      <if test="shopId != null" >
        #{shopId,jdbcType=INTEGER},
      </if>
      <if test="bookRuleId != null" >
        #{bookRuleId},
      </if>
      <if test="intevalId != null" >
        #{intevalId,jdbcType=INTEGER},
      </if>
      <if test="resourceNumber != null" >
        #{resourceNumber,jdbcType=INTEGER},
      </if>
      <if test="reserveResourceDate != null" >
        #{reserveResourceDate,jdbcType=DATE},
      </if>
      <if test="createTime != null" >
        #{createTime,jdbcType=TIMESTAMP},
      </if>
      <if test="status != null" >
        #{status},
      </if>
      <if test="userId != null" >
        #{userId},
      </if>
      <if test="userName != null" >
        #{userName},
      </if>
      <if test="mobile != null" >
        #{mobile},
      </if>
      <if test="startTime != null" >
        #{startTime},
      </if>
      <if test="endTime != null" >
        #{endTime},
      </if>
      <if test="resourceType != null" >
        #{resourceType},
      </if>
       <if test="minPeople != null" >
        #{minPeople},
      </if>
      <if test="maxPeople != null" >
        #{maxPeople},
      </if>
      <if test="bizId != null" >
        #{bizId},
      </if>
       <if test="bizName != null" >
        #{bizName},
      </if>
    </trim>
  </insert>
  
<!--   根据商铺id、分组名称查询资源信息 -->
  <select id="getGroupIdByName" parameterType="java.util.Map" resultType="java.lang.Long">
  	select
  		 srg.group_id
  	from 
  		 1dcq_shop_resource_group srg
  	where 
  		srg.group_name = #{groupName}
  	and
  		srg.shop_id = #{shopId} 
  	limit 1
  </select>
<!-- 查询时间段id -->
  <select id="getIntevalByShopId" parameterType="java.lang.Long" resultType="java.util.Map">
  	SELECT
  		 sti.inteval_id as intevalId,
  		 sti.start_time as startTime,
  		 sti.end_time as endTime
  	FROM 
  		 1dcq_shop_time_inteval sti
  	WHERE 
  		sti.shop_id = #{shopId}
  </select>
<!-- 根据orderid查询订单资源id信息 -->
  <select id="getOrderShopResourceByOrderId" parameterType="java.lang.String" resultType="java.util.Map">
  	SELECT
  		 osr.inteval_id as intevalId,
  		 osr.book_rule_id as bookRuleId,
  		 osr.resource_number as resourceNumber
  	FROM 
  		 1dcq_order_shop_resource osr
  	WHERE 
  		osr.order_id = #{orderId}
  </select>
<!-- 根据时间段id查询起始时间和结束时间 -->
  <select id="getIntevalTimeById" parameterType="java.lang.Long" resultType="java.util.Map">
  	SELECT
  		 sti.start_time as startTime,
  		 sti.end_time as endTime
  	FROM 
  		 1dcq_shop_time_inteval sti
  	WHERE 
  		sti.inteval_id = #{intevalId}
  	LIMIT 1
  </select>
<!-- 根据时间段id查询起始时间和结束时间 -->
  <select id="getBookTypeById" parameterType="java.lang.Long" resultType="java.util.Map">
  	SELECT
  		 br.book_type as bookType
  	FROM 
  		 1dcq_book_rule br
  	WHERE 
  		br.book_rule_id = #{bookRuleId}
  	LIMIT 1
  </select>
<!-- 根据orderId获取资源id -->
  <select id="getResourceIdByOrderId" parameterType="java.lang.String" resultType="java.lang.Long">
  	SELECT
  		 sr.resource_id as resourceId
  	FROM 
  		 1dcq_shop_resource sr
  	WHERE 
  		sr.order_id = #{orderId}
  	LIMIT 1
  </select>
  
  <select id="getShopBookOrders" parameterType="java.util.Map" resultMap="BaseResultMap">
  	select sr.*,ord.consumer_num  from 1dcq_order_shop_resource sr left join 1dcq_order ord on sr.order_id=ord.order_id 
  	where sr.shop_id=#{shopId}
  	<if test="bookTimeFrom!=null">
  	   <![CDATA[ and concat(sr.reserve_resource_date,' ',sr.start_time) >=#{bookTimeFrom}]]> 
  	</if>
  	<if test="bookTimeTo!=null">
  		 <![CDATA[  and concat(sr.reserve_resource_date,' ',sr.end_time)<=#{bookTimeTo}]]> 
  	</if>
  </select>
<!-- 根据orderId获取订单资源信息 -->
  <select id="getOrderResourceByOrderId" parameterType="java.lang.String" resultType="java.util.Map">
	SELECT 
	    osr.reserve_resource_date as reserveDate,
		osr.start_time as startTime,
		osr.resource_type as resourcType
	FROM 
		1dcq_order_shop_resource osr
  	WHERE 
  		osr.order_id = #{orderId}
  	LIMIT 1
  </select>
  
  <select id="getNeedAutoFinishOrder" resultMap="BaseResultMap" parameterType="java.lang.String">
  		select sr.order_id,sr.shop_id from 1dcq_order_shop_resource sr,1dcq_order ord where	 CONCAT(sr.reserve_resource_date,' ', sr.start_time) <![CDATA[ <=#{queryTime}]]>
  		 and ord.order_id=sr.order_id and ord.order_status in(0,1) and ord.pay_status=1 and sr.resource_type in (2,3)
  </select>
</mapper>