<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.idcq.appserver.dto.order.XorderDto" >
  <resultMap id="BaseResultMap" type="com.idcq.appserver.dto.order.XorderDto" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Apr 30 17:46:27 CST 2015.
    -->
    <id column="xorder_id" property="xorderId" jdbcType="VARCHAR" />
    <result column="user_info" property="userInfo" jdbcType="VARCHAR" />
    <result column="order_type" property="orderType" jdbcType="INTEGER" />
    <result column="order_time" property="orderTime" jdbcType="TIMESTAMP" />
    <result column="pay_status" property="payStatus" jdbcType="TINYINT" />
    <result column="goods_price_before_discount" property="goodsPriceBeforeDiscount" jdbcType="DECIMAL" />
    <result column="goods_price" property="goodsPrice" jdbcType="DECIMAL" />
    <result column="logistics_price" property="logisticsPrice" jdbcType="DECIMAL" />
    <result column="order_total_price" property="orderTotalPrice" jdbcType="DECIMAL" />
    <result column="settle_price" property="settlePrice" jdbcType="DECIMAL" />
    <result column="prepay_money" property="prepayMoney" jdbcType="DECIMAL" />
    <result column="settle_flag" property="settleFlag" jdbcType="TINYINT" />
    <result column="distribution_type" property="distributionType" jdbcType="TINYINT" />
    <result column="distribution_time" property="distributionTime" jdbcType="TIMESTAMP" />
    <result column="address_id" property="addressId" jdbcType="INTEGER" />
    <result column="pay_time_type" property="payTimeType" jdbcType="TINYINT" />
    <result column="order_service_type" property="orderServiceType" jdbcType="TINYINT" />
    <result column="service_time_from" property="serviceTimeFrom" jdbcType="TIMESTAMP" />
    <result column="service_time_to" property="serviceTimeTo" jdbcType="TIMESTAMP" />
    <result column="shop_id" property="shopId" jdbcType="INTEGER" />
    <result column="order_status" property="orderStatus" jdbcType="TINYINT" />
    <result column="order_scene_type" property="orderSceneType" jdbcType="TINYINT" />
    <!-- 20150703 -->
    <result column="consumer_num" property="consumerNum"  />
    <result column="seat_ids" property="seatIds"  />
    <!-- 20150712 -->
    <result column="is_maling" property="isMaling"  />
    <!-- 20150801 -->
    <result column="order_title" property="orderTitle"  />
    <result column="order_mobile" property="mobile"  />
    <result column="remark" property="remark"/>
    <result column="client_system_type" property="clientSystemType"/>
     <result column="order_channel_type" property="orderChannelType"/>
    <result column="cashier_id" property="cashierId"/>
    <result column="cashier_username" property="cashierUsername"/>
  </resultMap>
  
  <sql id="Base_Column_List" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Apr 30 17:46:27 CST 2015.
    -->
    xorder_id, user_info, order_type,order_title, order_time, pay_status, goods_price_before_discount, 
    goods_price, logistics_price, order_total_price, settle_price, prepay_money, settle_flag, 
    distribution_type, distribution_time, address_id, pay_time_type, order_service_type,order_channel_type,
    service_time_from, service_time_to, shop_id, order_status, order_scene_type,remark,client_system_type,cashier_id,cashier_username
  </sql>
  <sql id="Simple_Column_List" >
    xorder_id,
    pay_status, 
    order_status 
  </sql>
  <delete id="delXorderDto" parameterType="java.lang.String">
  	delete from 1dcq_xorder where xorder_id = #{orderId}
  </delete>
  <update id="canclXorder" parameterType="java.lang.String">
  	update 1dcq_xorder set order_status = 5 ,delete_type = 2 where xorder_id = #{orderId}
  </update>
  <select id="queryXorderExists" parameterType="java.lang.String" resultType="java.lang.Integer">
  	select count(1) from 1dcq_xorder where xorder_id = #{orderId}
  </select>
  <select id="getXorderSimple" parameterType="java.lang.String" resultMap="BaseResultMap">
  	select <include refid="Simple_Column_List" /> from 1dcq_xorder where xorder_id = #{orderId}
  </select>
    <select id="getXOrderById" parameterType="java.lang.String" resultMap="BaseResultMap">
  	select 
  		  <include refid="Base_Column_List" />
  	from 1dcq_xorder where xorder_id = #{orderId}
  	
  </select>
  <select id="getOrderStatusById" parameterType="java.lang.String" resultType="java.lang.Integer">
  	select 
  		order_status
  	from 1dcq_xorder where xorder_id = #{orderId}
  </select>
  <!-- 获取非会员订单实收金额 -->
  <select id="getSettingPriceByxorderId" parameterType="java.lang.String" resultType="java.math.BigDecimal">
	SELECT
		ROUND(IFNULL(x.settle_price,0),2) settlePrice
	FROM
		1dcq_xorder x
	WHERE
		x.xorder_id = #{xorderId}
  </select>
  <insert id="addXorderDto" parameterType="com.idcq.appserver.dto.order.XorderDto" >
    insert into 1dcq_xorder
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="xorderId != null" >
        xorder_id,
      </if>
      <if test="userInfo != null" >
        user_info,
      </if>
      <if test="orderType != null" >
        order_type,
      </if>
      <if test="orderTime != null" >
        order_time,
      </if>
      <if test="payStatus != null" >
        pay_status,
      </if>
      <if test="goodsPriceBeforeDiscount != null" >
        goods_price_before_discount,
      </if>
      <if test="goodsPrice != null" >
        goods_price,
      </if>
      <if test="logisticsPrice != null" >
        logistics_price,
      </if>
      <if test="orderTotalPrice != null" >
        order_total_price,
      </if>
      <if test="settlePrice != null" >
        settle_price,
      </if>
      <if test="prepayMoney != null" >
        prepay_money,
      </if>
      <if test="settleFlag != null" >
        settle_flag,
      </if>
      <if test="distributionType != null" >
        distribution_type,
      </if>
      <if test="distributionTime != null" >
        distribution_time,
      </if>
      <if test="addressId != null" >
        address_id,
      </if>
      <if test="payTimeType != null" >
        pay_time_type,
      </if>
      <if test="orderServiceType != null" >
        order_service_type,
      </if>
      <if test="serviceTimeFrom != null" >
        service_time_from,
      </if>
      <if test="serviceTimeTo != null" >
        service_time_to,
      </if>
      <if test="shopId != null" >
        shop_id,
      </if>
      <if test="orderStatus != null" >
        order_status,
      </if>
      <if test="orderSceneType != null" >
        order_scene_type,
      </if>
      <if test="consumerNum != null" >
        consumer_num,
      </if>
      <if test="seatIds != null" >
        seat_ids,
      </if>
      <if test="order_source != null" >
        order_source,
      </if>
      <if test="goodsNumber != null" >
        order_goods_number,
      </if>
      <if test="isMaling != null" >
        is_maling,
      </if>
      <if test="mobile != null" >
        order_mobile,
      </if>
      <if test="orderTitle != null" >
        order_title,
      </if>
       <if test="orderDiscount != null" >
      	order_discount,
      </if>
         <if test="cashierId != null" >
      	cashier_id,
      </if>
      <if test="cashierUsername != null" >
      	cashier_username,
      </if>
         <if test="clientSystemType != null" >
      	client_system_type,
      </if>
       <if test="orderChannelType != null" >
      	order_channel_type,
      </if>
          <if test="settleType != null" >
      	  settle_type,
      </if>
       <if test="remark != null" >
      	  remark
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="xorderId != null" >
        #{xorderId,jdbcType=VARCHAR},
      </if>
      <if test="userInfo != null" >
        #{userInfo,jdbcType=VARCHAR},
      </if>
      <if test="orderType != null" >
        #{orderType,jdbcType=INTEGER},
      </if>
      <if test="orderTime != null" >
        #{orderTime,jdbcType=TIMESTAMP},
      </if>
      <if test="payStatus != null" >
        #{payStatus,jdbcType=TINYINT},
      </if>
      <if test="goodsPriceBeforeDiscount != null" >
        #{goodsPriceBeforeDiscount,jdbcType=DECIMAL},
      </if>
      <if test="goodsPrice != null" >
        #{goodsPrice,jdbcType=DECIMAL},
      </if>
      <if test="logisticsPrice != null" >
        #{logisticsPrice,jdbcType=DECIMAL},
      </if>
      <if test="orderTotalPrice != null" >
        #{orderTotalPrice,jdbcType=DECIMAL},
      </if>
      <if test="settlePrice != null" >
        #{settlePrice,jdbcType=DECIMAL},
      </if>
      <if test="prepayMoney != null" >
        #{prepayMoney,jdbcType=DECIMAL},
      </if>
      <if test="settleFlag != null" >
        #{settleFlag,jdbcType=TINYINT},
      </if>
      <if test="distributionType != null" >
        #{distributionType,jdbcType=TINYINT},
      </if>
      <if test="distributionTime != null" >
        #{distributionTime,jdbcType=TIMESTAMP},
      </if>
      <if test="addressId != null" >
        #{addressId,jdbcType=INTEGER},
      </if>
      <if test="payTimeType != null" >
        #{payTimeType,jdbcType=TINYINT},
      </if>
      <if test="orderServiceType != null" >
        #{orderServiceType,jdbcType=TINYINT},
      </if>
      <if test="serviceTimeFrom != null" >
        #{serviceTimeFrom,jdbcType=TIMESTAMP},
      </if>
      <if test="serviceTimeTo != null" >
        #{serviceTimeTo,jdbcType=TIMESTAMP},
      </if>
      <if test="shopId != null" >
        #{shopId,jdbcType=INTEGER},
      </if>
      <if test="orderStatus != null" >
        #{orderStatus,jdbcType=TINYINT},
      </if>
      <if test="orderSceneType != null" >
        #{orderSceneType,jdbcType=TINYINT},
      </if>
      <if test="consumerNum != null" >
       	#{consumerNum},
      </if>
      <if test="seatIds != null" >
      	#{seatIds},
      </if>
       <if test="order_source != null" >
        #{order_source},
      </if>
      <if test="goodsNumber != null" >
        #{goodsNumber},
      </if>
      <if test="isMaling != null" >
        #{isMaling},
      </if>
      <if test="mobile != null" >
        #{mobile},
      </if>
      <if test="orderTitle != null" >
        #{orderTitle},
      </if>
        <if test="orderDiscount != null" >
      	#{orderDiscount},
      </if>
      <if test="cashierId != null" >
        	#{cashierId},
      </if>
      <if test="cashierUsername != null" >
      	#{cashierUsername},
      </if>
         <if test="clientSystemType != null" >
      	#{clientSystemType},
      </if>
          <if test="orderChannelType != null" >
      	#{orderChannelType},
      </if>
        <if test="settleType != null" >
      	#{settleType},
      </if>
      <if test="remark != null" >
      	  #{remark}
      </if>
    </trim>
  </insert>
   <update id="updateXorderDto" parameterType="com.idcq.appserver.dto.order.XorderDto" >
    update 1dcq_xorder
    <set >
      <if test="userInfo != null" >
        user_info = #{userInfo,jdbcType=VARCHAR},
      </if>
      <if test="orderType != null" >
        order_type = #{orderType,jdbcType=INTEGER},
      </if>
      <if test="orderTime != null" >
        order_time = #{orderTime,jdbcType=TIMESTAMP},
      </if>
      <if test="payStatus != null" >
        pay_status = #{payStatus,jdbcType=TINYINT},
      </if>
      <if test="goodsPriceBeforeDiscount != null" >
        goods_price_before_discount = #{goodsPriceBeforeDiscount,jdbcType=DECIMAL},
      </if>
      <if test="goodsPrice != null" >
        goods_price = #{goodsPrice,jdbcType=DECIMAL},
      </if>
      <if test="logisticsPrice != null" >
        logistics_price = #{logisticsPrice,jdbcType=DECIMAL},
      </if>
      <if test="orderTotalPrice != null" >
        order_total_price = #{orderTotalPrice,jdbcType=DECIMAL},
      </if>
      <if test="settlePrice != null" >
        settle_price = #{settlePrice,jdbcType=DECIMAL},
      </if>
      <if test="prepayMoney != null" >
        prepay_money = #{prepayMoney,jdbcType=DECIMAL},
      </if>
      <if test="settleFlag != null" >
        settle_flag = #{settleFlag,jdbcType=TINYINT},
      </if>
      <if test="distributionType != null" >
        distribution_type = #{distributionType,jdbcType=TINYINT},
      </if>
      <if test="distributionTime != null" >
        distribution_time = #{distributionTime,jdbcType=TIMESTAMP},
      </if>
      <if test="addressId != null" >
        address_id = #{addressId,jdbcType=INTEGER},
      </if>
      <if test="payTimeType != null" >
        pay_time_type = #{payTimeType,jdbcType=TINYINT},
      </if>
      <if test="orderServiceType != null" >
        order_service_type = #{orderServiceType,jdbcType=TINYINT},
      </if>
      <if test="serviceTimeFrom != null" >
        service_time_from = #{serviceTimeFrom,jdbcType=TIMESTAMP},
      </if>
      <if test="serviceTimeTo != null" >
        service_time_to = #{serviceTimeTo,jdbcType=TIMESTAMP},
      </if>
      <if test="shopId != null" >
        shop_id = #{shopId,jdbcType=INTEGER},
      </if>
      <if test="orderStatus != null" >
        order_status = #{orderStatus,jdbcType=TINYINT},
      </if>
      <if test="orderSceneType != null" >
        order_scene_type = #{orderSceneType,jdbcType=TINYINT},
      </if>
      <if test="consumerNum != null" >
       	consumer_num = #{consumerNum},
      </if>
      <if test="seatIds != null" >
      	seat_ids = #{seatIds},
      </if>
      <if test="order_source != null" >
       	order_source = #{order_source},
      </if>
      <if test="goodsNumber != null" >
      	order_goods_number = #{goodsNumber},
      </if>
      <if test="isMaling!=null" >
      	is_maling = #{isMaling},
      </if>
      <if test="orderDiscount != null" >
      	order_discount = #{orderDiscount},
      </if>
      <if test="cashierId != null" >
        cashier_id = #{cashierId},
      </if>
      <if test="deleteType != null" >
       	delete_type = #{deleteType},
      </if>
      <if test="orderTitle != null" >
        order_title = #{orderTitle},
      </if>
    </set>
    where xorder_id = #{xorderId,jdbcType=VARCHAR}
  </update>
  
  <select id="getShopOfflineOrders" resultType="java.util.Map" parameterType="java.util.Map">
     <![CDATA[
     select
         o.xorder_id  AS xOrderId,
         osr.username AS userName, 
		 osr.mobile,
         o.shop_id AS shopId,
         o.order_title AS orderTitle,
         if(o.order_status=5, 1, 0) AS orderStatus,
         o.order_total_price AS orderTotalPrice,
         CONCAT(DATE_FORMAT(osr.reserve_resource_date,'%Y-%m-%d'), ' ', IFNULL(DATE_FORMAT(osr.start_time,'%H:%i'), '00:00')) AS bookTime
    from 1dcq_xorder o
    INNER JOIN 1dcq_order_shop_resource osr
		  ON o.xorder_id = osr.order_id
    where o.shop_id = #{shopId}
    AND osr.reserve_resource_date  > SUBDATE(CURDATE(), INTERVAL #{day} DAY)
      ]]> 
      order by o.order_time DESC
  </select>
  
  <select id="getGoodsLogoByXorderId" resultType="java.lang.String" parameterType="java.lang.String" >
        SELECT a.file_url AS fileUrl
          FROM 1dcq_order_shop_resource osr
    INNER JOIN 1dcq_shop_resource sr
            ON osr.biz_id = sr.resource_id
           AND osr.resource_type = 3
    INNER JOIN 1dcq_goods_category gc 
            ON sr.goods_category_id = gc.goods_category_id
    INNER JOIN 1dcq_attachment_relation ar
            ON gc.goods_category_id = ar.biz_id 
            OR gc.`parent_category_id` = ar.biz_id
           AND ar.biz_type = 11
           AND ar.pic_type = 1
    INNER JOIN 1dcq_attachment a
            ON ar.attachement_id = a.attachement_id
         WHERE osr.order_id = #{xOrderId}
           AND a.file_url IS NOT NULL 
           limit 1
  </select>
</mapper>