<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.idcq.appserver.dto.pay.OrderGoodsSettle" >
 <resultMap id="BaseResultMap" type="com.idcq.appserver.dto.pay.OrderGoodsSettle" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Apr 07 15:01:19 CST 2015.
    -->
    <id column="ogs_id" property="ogsId" jdbcType="BIGINT" />
    <result column="order_id" property="orderId" jdbcType="VARCHAR" />
    <result column="user_id" property="userId" jdbcType="INTEGER" />
    <result column="order_time" property="orderTime" jdbcType="INTEGER" />
    <result column="order_goods_price_before_discount" property="orderGoodsPriceBeforeDiscount" jdbcType="DECIMAL" />
    <result column="order_goods_price" property="orderGoodsPrice" jdbcType="DECIMAL" />
    <result column="order_logistics_price" property="orderLogisticsPrice" jdbcType="DECIMAL" />
    <result column="order_total_price" property="orderTotalPrice" jdbcType="DECIMAL" />
    <result column="order_settle_price" property="orderSettlePrice" jdbcType="DECIMAL" />
    <result column="order_goods_id" property="orderGoodsId" jdbcType="INTEGER" />
    <result column="shop_id" property="shopId" jdbcType="INTEGER" />
    <result column="goods_id" property="goodsId" jdbcType="INTEGER" />
    <result column="goods_number" property="goodsNumber" jdbcType="DOUBLE" />
    <result column="goods_standard_price" property="goodsStandardPrice" jdbcType="DECIMAL" />
    <result column="shop_income_price" property="shopIncomePrice" jdbcType="DECIMAL" />
    <result column="shop_income_ratio" property="shopIncomeRatio" jdbcType="DECIMAL" />
    <result column="shop_income_settle_flag" property="shopIncomeSettleFlag" jdbcType="INTEGER" />
    <result column="platform_total_income_ratio" property="platformTotalIncomeRatio" jdbcType="DECIMAL" />
    <result column="platform_total_income_price" property="platformTotalIncomePrice" jdbcType="DECIMAL" />
    <result column="platform_net_income_price" property="platformNetIncomePrice" jdbcType="DECIMAL" />
    <result column="user_share_price" property="userSharePrice" jdbcType="DECIMAL" />
    <result column="user_share_ratio" property="userShareRatio" jdbcType="DECIMAL" />
    <result column="user_share_settle_flag" property="userShareSettleFlag" jdbcType="BIT" />
    <result column="user_ref_share_price" property="userRefSharePrice" jdbcType="DECIMAL" />
    <result column="user_ref_share_ratio" property="userRefShareRatio" jdbcType="DECIMAL" />
    <result column="user_ref_share_settle_flag" property="userRefShareSettleFlag" jdbcType="BIT" />
    <result column="user_ref_share_user_id" property="userRefShareUserId" jdbcType="INTEGER" />
    <result column="user_ref_share_user_type" property="userRefShareUserType" jdbcType="INTEGER" />
    <result column="shop_ref_share_price" property="shopRefSharePrice" jdbcType="DECIMAL" />
    <result column="shop_ref_share_ratio" property="shopRefShareRatio" jdbcType="DECIMAL" />
    <result column="shop_ref_share_settle_flag" property="shopRefShareSettleFlag" jdbcType="BIT" />
    <result column="shop_ref_share_user_id" property="shopRefShareUserId" jdbcType="INTEGER" />
    <result column="shop_ref_share_user_type" property="shopRefShareUserType" jdbcType="INTEGER" />
    <result column="shop_serve_share_price" property="shopServeSharePrice" jdbcType="DECIMAL" />
    <result column="shop_serve_share_ratio" property="shopServeShareRatio" jdbcType="DECIMAL" />
    <result column="shop_serve_share_settle_flag" property="shopServeShareSettleFlag" jdbcType="BIT" />
    <result column="shop_serve_share_user_id" property="shopServeShareUserId" jdbcType="INTEGER" />
    <result column="level1_agent_price" property="level1AgentPrice" jdbcType="DECIMAL" />
    <result column="level1_agent_share_ratio" property="level1AgentShareRatio" jdbcType="DECIMAL" />
    <result column="level1_agent_share_settle_flag" property="level1AgentShareSettleFlag" jdbcType="BIT" />
    <result column="level1_agent_share_user_id" property="level1AgentShareUserId" jdbcType="INTEGER" />
    <result column="city_id" property="cityId" jdbcType="INTEGER" />
    <result column="level2_agent_price" property="level2AgentPrice" jdbcType="DECIMAL" />
    <result column="level2_agent_share_ratio" property="level2AgentShareRatio" jdbcType="DECIMAL" />
    <result column="level2_agent_share_settle_flag" property="level2AgentShareSettleFlag" jdbcType="BIT" />
    <result column="level2_agent_share_user_id" property="level2AgentShareUserId" jdbcType="INTEGER" />
    <result column="district_id" property="districtId" jdbcType="INTEGER" />
    <result column="level3_agent_price" property="level3AgentPrice" jdbcType="DECIMAL" />
    <result column="level3_agent_share_ratio" property="level3AgentShareRatio" jdbcType="DECIMAL" />
    <result column="level3_agent_share_settle_flag" property="level3AgentShareSettleFlag" jdbcType="BIT" />
    <result column="level3_agent_share_user_id" property="level3AgentShareUserId" jdbcType="INTEGER" />
    <result column="town_id" property="townId" jdbcType="INTEGER" />
    <result column="create_time" property="createTime" jdbcType="TIMESTAMP" />
    <result column="shop_settle_delay_days" property="shopSettleDelayDays" jdbcType="INTEGER" />
    <result column="user_settle_delay_days" property="userSettleDelayDays" jdbcType="TIMESTAMP" />
  </resultMap>
  <!-- 调用订单结算储存过程 -->
  <update id="detailOrderGoodsSettle" parameterType="java.util.Map" statementType="CALLABLE">  
  	{call SP_ORDER_GOODS_SETTLE(  
	    #{userId,jdbcType=INTEGER,mode=IN},
	    #{shopId,jdbcType=INTEGER,mode=IN}, 
	    #{goodsId,jdbcType=INTEGER,mode=IN}, 
	    #{orderId,jdbcType=VARCHAR,mode=IN}
	  )
    }  
  </update> 
    <!-- 调用分账结算储存过程 -->
  <update id="updateOrderGoodsSettle" parameterType="java.util.Map" statementType="CALLABLE">  
  	{call SP_UPDATE_ORDER_GOODS_SETTLE(  
	    #{userId,jdbcType=INTEGER,mode=IN},
	    #{shopId,jdbcType=INTEGER,mode=IN}, 
	    #{goodsId,jdbcType=INTEGER,mode=IN}, 
	    #{orderId,jdbcType=VARCHAR,mode=IN},
	    #{oType,jdbcType=VARCHAR,mode=IN}
	  )
    }  
  </update> 
    <!-- 调用分账结算储存过程Shop -->
  <update id="updateOrderGoodsSettleShop" parameterType="java.util.Map" statementType="CALLABLE">  
  	{call SP_UPDATE_ORDER_GOODS_SETTLE_SHOP(  
	    #{userId,jdbcType=INTEGER,mode=IN},
	    #{shopId,jdbcType=INTEGER,mode=IN}, 
	    #{goodsId,jdbcType=INTEGER,mode=IN}, 
	    #{orderId,jdbcType=VARCHAR,mode=IN},
	    #{oType,jdbcType=VARCHAR,mode=IN}
	  )
    }  
  </update> 
    <!-- 查询订单结算 -->
  <select id="getOrderGoodsSettle" resultMap="BaseResultMap" parameterType="java.util.Map">
	SELECT
		<include refid="Base_Column_List" />
	FROM
		1dcq_order_goods_settle ogs
	LEFT JOIN 
		1dcq_order_goods_settle_setting gss
	ON
		1=1
	WHERE
		ogs.user_share_settle_flag = 0
 	<if test="userId != null">
		AND
		ogs.user_Id = #{userId,jdbcType=INTEGER}
	</if>
	<if test="shopId != null">
		AND 
		ogs.shop_id = #{shopId,jdbcType=INTEGER}
	</if>
	<if test="goodsId != null">
		AND 
		ogs.goods_id = #{goodsId,jdbcType=INTEGER}	
	</if>
	<if test="orderId">
		AND 
		ogs.order_id = #{orderId,jdbcType=VARCHAR}	
	</if> 
	GROUP BY
		ogs.order_id
	LIMIT #{skip},20
		
  </select>  
  
    <!-- 查询订单结算 Shop-->
  <select id="getOrderGoodsSettleShop" resultMap="BaseResultMap" parameterType="java.util.Map">
	SELECT
		<include refid="Base_Column_List" />
	FROM
		1dcq_order_goods_settle ogs
	LEFT JOIN 
		1dcq_order_goods_settle_setting gss
	ON
		1=1
	WHERE
		ogs.shop_income_settle_flag = 0
 	<if test="userId != null">
		AND
		ogs.user_Id = #{userId,jdbcType=INTEGER}
	</if>
	<if test="shopId != null">
		AND 
		ogs.shop_id = #{shopId,jdbcType=INTEGER}
	</if>
	<if test="goodsId != null">
		AND 
		ogs.goods_id = #{goodsId,jdbcType=INTEGER}	
	</if>
	<if test="orderId">
		AND 
		ogs.order_id = #{orderId,jdbcType=VARCHAR}	
	</if> 
	GROUP BY
		ogs.order_id
	LIMIT #{skip},20	
  </select>  
  <insert id="addOrderGoodsSettleLog" parameterType="com.idcq.appserver.dto.pay.OrderGoodsSettle">
     insert into 
     	1dcq_order_goods_settle_log (
	    order_id,
		user_id, 
	    shop_id,
		goods_id,
		create_time
      )
    values (
    #{orderId,jdbcType=VARCHAR},
	#{userId,jdbcType=INTEGER}, 
    #{shopId,jdbcType=INTEGER},
	#{goodsId,jdbcType=INTEGER},
	now()
      ) 
  </insert>
  <sql id="Base_Column_List" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue Apr 07 15:01:19 CST 2015.
    -->
    ogs.ogs_id, ogs.order_id, ogs.user_id, ogs.order_time, ogs.order_goods_price_before_discount, ogs.order_goods_price, 
    ogs.order_logistics_price, ogs.order_total_price, ogs.order_settle_price, ogs.order_goods_id, ogs.shop_id, 
    ogs.goods_id, ogs.goods_number, ogs.goods_standard_price, ogs.shop_income_price, ogs.shop_income_ratio, 
    ogs.platform_total_income_ratio, ogs.platform_total_income_price, ogs.platform_net_income_price, 
    ogs.user_share_price,ogs.user_share_ratio, ogs.user_share_settle_flag, ogs.user_ref_share_price, 
    ogs.user_ref_share_ratio, ogs.user_ref_share_settle_flag, ogs.user_ref_share_user_id, ogs.user_ref_share_user_type, 
    ogs.shop_ref_share_price, ogs.shop_ref_share_ratio, ogs.shop_ref_share_settle_flag, ogs.shop_ref_share_user_id, 
    ogs.shop_ref_share_user_type, ogs.shop_serve_share_price, ogs.shop_serve_share_ratio, ogs.shop_serve_share_settle_flag, 
    ogs.shop_serve_share_user_id, ogs.level1_agent_price, ogs.level1_agent_share_ratio, ogs.level1_agent_share_settle_flag, 
    ogs.level1_agent_share_user_id, ogs.city_id, ogs.level2_agent_price, ogs.level2_agent_share_ratio, 
    ogs.level2_agent_share_settle_flag, ogs.level2_agent_share_user_id, ogs.district_id, ogs.level3_agent_price, 
    ogs.level3_agent_share_ratio, ogs.level3_agent_share_settle_flag, ogs.level3_agent_share_user_id, 
    ogs.town_id, ogs.create_time,gss.shop_settle_delay_days,gss.user_settle_delay_days
  </sql>
  
  <select id="getPlatformTotalPrice" parameterType="java.lang.String" resultType="double">
    	select ifnull(sum(platform_total_income_price),0) 
    	from 1dcq_order_goods_settle 
    	where order_id=#{orderId}
   </select>  
   
   <select id="getOrderGoodsSettleMoney" parameterType="java.util.Map" resultMap="BaseResultMap">
    	SELECT user_share_settle_flag,user_ref_share_user_id,shop_ref_share_user_id,shop_serve_share_user_id,level1_agent_share_user_id,level2_agent_share_user_id,
    	level3_agent_share_user_id,TRUNCATE(SUM(user_share_price),4),TRUNCATE(SUM(user_ref_share_price),4),TRUNCATE(SUM(shop_ref_share_price),4),
    	TRUNCATE(SUM(shop_serve_share_price),4),TRUNCATE(SUM(level1_agent_price),4),TRUNCATE(SUM(level2_agent_price),4),TRUNCATE(SUM(level3_agent_price),4),
    	shop_income_settle_flag,shop_id
		FROM  1dcq_order_goods_settle
    	where order_id=#{orderId}
   </select> 
   
   <!-- 更新结账表 -->
    <update id="updateOrderGoodsSettleStatus" parameterType="com.idcq.appserver.dto.pay.OrderGoodsSettle">  
	  	update 1dcq_order_goods_settle
	    <set>
	      <if test="shopIncomeSettleFlag != null" >
	        shop_income_settle_flag=#{shopIncomeSettleFlag},
	      </if>
	    </set>
	    where order_id = #{orderId}
  </update> 
   
  
  <insert id="saveOrderGoodsSettle" parameterType="com.idcq.appserver.dto.pay.OrderGoodsSettle" keyProperty="ogsId" useGeneratedKeys="true">
	INSERT INTO 1dcq_order_goods_settle
	(
	order_id,
	user_id,
	order_time,
	order_goods_price_before_discount,
	order_goods_price,
	order_logistics_price,
	order_total_price,
	order_settle_price,
	order_goods_id,
	shop_id,
	goods_id,
	goods_number,
	goods_standard_price,
	shop_income_price,
	shop_income_ratio,
	shop_member_discount,
	platform_total_income_price,
	platform_total_income_ratio,
	platform_net_income_price,
	user_share_price,
	user_share_ratio,
	user_share_settle_flag,
	user_ref_share_price,
	user_ref_share_ratio,
	user_ref_share_settle_flag,
	user_ref_share_user_id,
	user_ref_share_user_type,
	shop_ref_share_price,
	shop_ref_share_ratio,
	shop_ref_share_settle_flag,
	shop_ref_share_user_id,
	shop_ref_share_user_type,
	shop_serve_share_price,
	shop_serve_share_ratio,
	shop_serve_share_settle_flag,
	shop_serve_share_user_id,
	level1_agent_price,
	level1_agent_share_ratio,
	level1_agent_share_settle_flag,
	level1_agent_share_user_id,
	city_id,
	level2_agent_price,
	level2_agent_share_ratio,
	level2_agent_share_settle_flag,
	level2_agent_share_user_id,
	district_id,
	level3_agent_price,
	level3_agent_share_ratio,
	level3_agent_share_settle_flag,
	level3_agent_share_user_id,
	town_id,
	create_time)
	VALUES (
	#{orderId},
	#{userId},
	#{orderTime},
	#{orderGoodsPriceBeforeDiscount},
	#{orderGoodsPrice},
	#{orderLogisticsPrice},
	#{orderTotalPrice},
	#{orderSettlePrice},
	#{orderGoodsId},
	#{shopId},
	#{goodsId},
	#{goodsNumber},
	#{goodsStandardPrice},
	#{shopIncomePrice},
	#{shopIncomeRatio},
	#{shopMemberDiscount},
	#{platformTotalIncomePrice},
	#{platformTotalIncomeRatio},
	#{platformNetIncomePrice},
	#{userSharePrice},
	#{userShareRatio},
	#{userShareSettleFlag},
	#{userRefSharePrice},
	#{userRefShareRatio},
	#{userRefShareSettleFlag},
	#{userRefShareUserId},
	#{userRefShareUserType},
	#{shopRefSharePrice},
	#{shopRefShareRatio},
	#{shopRefShareSettleFlag},
	#{shopRefShareUserId},
	#{shopRefShareUserType},
	#{shopServeSharePrice},
	#{shopServeShareRatio},
	#{shopServeShareSettleFlag},
	#{shopServeShareUserId},
	#{level1AgentPrice},
	#{level1AgentShareRatio},
	#{level1AgentShareSettleFlag},
	#{level1AgentShareUserId},
	#{cityId},
	#{level2AgentPrice},
	#{level2AgentShareRatio},
	#{level2AgentShareSettleFlag},
	#{level2AgentShareUserId},
	#{districtId},
	#{level3AgentPrice},
	#{level3AgentShareRatio},
	#{level3AgentShareSettleFlag},
	#{level3AgentShareUserId},
	#{townId},
	#{createTime});
  </insert>
  
  
</mapper>