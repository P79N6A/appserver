<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.idcq.appserver.dto.user.UserDto" >
  <resultMap id="BaseResultMap" type="com.idcq.appserver.dto.user.UserDto" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Mar 11 10:39:12 CST 2015.
    -->
    <id column="user_id" property="userId" jdbcType="INTEGER" />
    <result column="user_type" property="userType" jdbcType="TINYINT" />
    <result column="user_type2" property="userType2" jdbcType="TINYINT" />
    <result column="is_member" property="isMember" jdbcType="TINYINT" />
    <result column="status" property="status" jdbcType="TINYINT" />
    <result column="status_desc" property="statusDesc" jdbcType="VARCHAR" />
    <result column="username" property="userName" jdbcType="VARCHAR" />
    <result column="nick_name" property="nikeName" jdbcType="VARCHAR" />
    <result column="identity_card_no" property="identityCardNo" jdbcType="VARCHAR" />
    <result column="mobile" property="mobile" jdbcType="VARCHAR" />
    <result column="password" property="password" jdbcType="VARCHAR" />
    <result column="true_name" property="trueName" jdbcType="VARCHAR" />
    <result column="refer_user_id" property="referUserId" jdbcType="INTEGER" />
    <result column="refer_shop_id" property="referShopId" jdbcType="INTEGER" />
    <result column="refer_type" property="referType" jdbcType="INTEGER" />
    <result column="sex" property="sex" jdbcType="BIT" />
    <result column="create_time" property="createTime" jdbcType="TIMESTAMP" />
    <result column="first_login_time" property="firstLoginTime" jdbcType="TIMESTAMP" />
    <result column="last_update_time" property="lastUpdateTime" jdbcType="TIMESTAMP" />
    <result column="big_logo" property="bigLogo" jdbcType="VARCHAR" />
    <result column="small_logo" property="smallLogo" jdbcType="VARCHAR" />
    <result column="pay_password" property="payPassword" jdbcType="VARCHAR" />
    <result column="withdraw_password" property="withdrawPassword" jdbcType="VARCHAR" />
    <result column="email" property="email" jdbcType="VARCHAR" />
    <result column="weixin_no" property="weixinNo" jdbcType="VARCHAR" />
    <result column="qq_no" property="qqNo" jdbcType="VARCHAR" />
    <!-- 20150321 add -->
    <result column="identity_card_pic1" property="identityCardPic1" jdbcType="INTEGER" />
    <result column="identity_card_pic2" property="identityCardPic2" jdbcType="INTEGER" />
    <result column="register_type" property="registerType" jdbcType="VARCHAR" />
    <result column="province_id" property="provinceId" jdbcType="INTEGER" />
    <result column="city_id" property="cityId" jdbcType="INTEGER" />
    <result column="district_id" property="districtId" jdbcType="INTEGER" />
    <result column="town_id" property="townId" jdbcType="INTEGER" />
    <result column="resident_town" property="residentTown" jdbcType="VARCHAR" />
    <result column="birthday" property="birthday" jdbcType="TIMESTAMP" />
    <result column="user_mac" property="sn" jdbcType="VARCHAR" />
    <result column="last_login_time" property="lastLoginTime" jdbcType="TIMESTAMP" />

    <result column="is_shop_maneger" property="isShopManager" jdbcType="INTEGER" />

    <result column="rebates_level" property="rebatesLevel"/>

    <result column="is_group_leader" property="isGroupLeader" javaType="boolean"/>
    <result column="refer_agent_num" property="referAgentNum"/>
    <result column="refer_agent_num2" property="referAgentNum2"/>

  </resultMap>

  <sql id="Base_Column_List" >
    user_id, 
    user_type, 
    user_type2, 
    is_member,
    status, 
    status_desc, 
    userName,
    nick_name,
    identity_card_no, 
    mobile, 
    password, 
    true_name, 
    refer_user_id, 
    refer_shop_id, 
    refer_type, 
    sex, 
    create_time, 
    first_login_time, 
    last_update_time, 
    big_logo, 
    small_logo, 
    pay_password,
    withdraw_password, 
    email, 
    weixin_no, 
    qq_no,
    identity_card_pic1,
    identity_card_pic2,
    register_type, 
    province_id,
    city_id,
    district_id,
    town_id,
    resident_town,
    birthday,
    user_mac,
    last_login_time,
    rebates_level,
    is_shop_maneger,
    is_group_leader,
    refer_agent_num,
    refer_agent_num2

  </sql>
  <select id="queryUserExistsById" parameterType="java.lang.Long" resultType="int">
  	select count(1) from 1dcq_user where user_id = #{userId} and status = 1
  </select>
  
  <select id="getById" resultMap="BaseResultMap" parameterType="java.lang.Long" >
    select
    <include refid="Base_Column_List" />
    from 1dcq_user
    where user_id = #{primaryKeyId}
  </select>
  
  <select id="getUserById" resultMap="BaseResultMap" parameterType="java.lang.Long" >
    select
    <include refid="Base_Column_List" />
    from 1dcq_user
    where user_id = #{userId}
  </select>
  
  <select id="queryUserExistsByMobile" parameterType="java.lang.String" resultType="java.lang.Integer">
  	select count(1) from 1dcq_user where mobile = #{mobile} and status = 1
  </select>
  
  <select id="authenUserById" resultType="java.lang.Long" parameterType="java.lang.Long" >
    select user_id from 1dcq_user where user_id = #{userId}
  </select>
  <!-- 查询用户状态 -->
	<select id="queryUserStatus" resultType="java.util.Map" parameterType="java.lang.Long">
		SELECT
			u.user_id,
			u.mobile,
			u.pay_password,
			u.`status`
		FROM
			1dcq_user u
		WHERE
			u.user_id = #{userId}
	</select>
  <select id="getPayPasswordByUser" resultType="java.lang.String" parameterType="java.lang.String" >
    select
    pay_password
    from 1dcq_user
    where mobile = #{mobile}
  </select>
  
  <select id="getUserByMobile" resultMap="BaseResultMap" parameterType="java.lang.String" >
    select
    <include refid="Base_Column_List" />
    from 1dcq_user
    where mobile = #{mobile}
  </select>
  <select id="getUserByOpenId" resultMap="BaseResultMap" parameterType="java.lang.String" >
    select
    <include refid="Base_Column_List" />
    from 1dcq_user
    where weixin_no = #{openId}
    and status = 1
  </select>
   <!-- 查询当前手机号码是否是平台会员 -->
  <select id="queryNormalUserByMobile" resultType="java.lang.Integer" parameterType="java.lang.String" >
    select
    count(1)
    from 1dcq_user
    where mobile = #{mobile} and is_member = 1 limit 1
  </select>
  <select id="getPasswordByMobile" resultType="java.lang.String" parameterType="java.lang.String" >
    select password from 1dcq_user where mobile = #{mobile}
  </select>
  
   <select id="getMobileByUserId" resultType="java.lang.String" parameterType="java.lang.Long" >
    select mobile from 1dcq_user where user_id = #{userId}
  </select>
  <select id="getPasswordByUserName" resultType="java.lang.String" parameterType="java.util.Map" >
    select password from 1dcq_user where username = #{userName}
  </select>
  <insert id="saveUser" parameterType="com.idcq.appserver.dto.user.UserDto" useGeneratedKeys="true" keyProperty="userId" >
    insert into 1dcq_user     
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="userType != null" >
        user_type,
      </if>
      <if test="userType2 != null" >
        user_type2,
      </if>
      <if test="isMember != null" >
        is_member,
      </if>
      <if test="status != null" >
        status,
      </if>
      <if test="statusDesc != null" >
        status_desc,
      </if>
      <if test="userName != null" >
        userName,
      </if>
       <if test="nikeName != null" >
        nick_name,
      </if>
      <if test="identityCardNo != null" >
        identity_card_no,
      </if>
      <if test="mobile != null" >
        mobile,
      </if>
      <if test="password != null" >
        password,
      </if>
      <if test="trueName != null" >
        true_name,
      </if>
      <if test="referUserId != null" >
        refer_user_id,
      </if>
      <if test="referShopId != null" >
        refer_shop_id,
      </if>
      <if test="referType != null" >
        refer_type,
      </if>
      <if test="sex != null" >
        sex,
      </if>
      <if test="createTime != null" >
        create_time,
      </if>
      <if test="firstLoginTime != null" >
        first_login_time,
      </if>
      <if test="lastUpdateTime != null" >
        last_update_time,
      </if>
      <if test="bigLogo != null" >
        big_logo,
      </if>
      <if test="smallLogo != null" >
        small_logo,
      </if>
      <if test="payPassword != null" >
        pay_password,
      </if>
      <if test="withdrawPassword != null" >
        withdraw_password,
      </if>
      <if test="email != null" >
        email,
      </if>
      <if test="weixinNo != null" >
        weixin_no,
      </if>
      <if test="qqNo != null" >
        qq_no,
      </if>
      <if test="type != null" >
        type,
      </if>
      <if test="identityCardPic1 != null">
      identity_card_pic1,
      </if>
      <if test="identityCardPic2 != null">
      identity_card_pic2,
      </if>
      <if test="registerType != null">
      register_type,
      </if>
      <if test="provinceId">
      province_id,
      </if>
      <if test="cityId">
      city_id,
      </if>
      <if test="districtId">
      district_id,
      </if>
      <if test="townId">
      town_id,
      </if>
     <if test="birthday">
      birthday,
      </if>
      <if test="rebatesLevel">
        rebates_level,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="userType != null" >
        #{userType,jdbcType=TINYINT},
      </if>
      <if test="userType2 != null" >
        #{userType2,jdbcType=TINYINT},
      </if>
      <if test="isMember != null" >
        #{isMember,jdbcType=TINYINT},
      </if>
      <if test="status != null" >
        #{status,jdbcType=TINYINT},
      </if>
      <if test="statusDesc != null" >
        #{statusDesc,jdbcType=VARCHAR},
      </if>
      <if test="userName != null" >
        #{userName,jdbcType=VARCHAR},
      </if>
        <if test="nikeName != null" >
          #{nikeName,jdbcType=VARCHAR},
      </if>
      <if test="identityCardNo != null" >
        #{identityCardNo,jdbcType=VARCHAR},
      </if>
      
      <if test="mobile != null" >
         #{mobile,jdbcType=VARCHAR}, 
      </if>
      <if test="password != null" >
        #{password,jdbcType=VARCHAR},
      </if>
      <if test="trueName != null" >
        #{trueName,jdbcType=VARCHAR},
      </if>
      <if test="referUserId != null" >
        #{referUserId,jdbcType=INTEGER},
      </if>
      <if test="referShopId != null" >
        #{referShopId,jdbcType=INTEGER},
      </if>
      <if test="referType != null" >
        #{referType,jdbcType=INTEGER},
      </if>
      <if test="sex != null" >
        #{sex,jdbcType=BIT},
      </if>
      <if test="createTime != null" >
        #{createTime,jdbcType=TIMESTAMP},
      </if>
      <if test="firstLoginTime != null" >
        #{firstLoginTime,jdbcType=TIMESTAMP},
      </if>
      <if test="lastUpdateTime != null" >
        #{lastUpdateTime,jdbcType=TIMESTAMP},
      </if>
      <if test="bigLogo != null" >
        #{bigLogo,jdbcType=VARCHAR},
      </if>
      <if test="smallLogo != null" >
        #{smallLogo,jdbcType=VARCHAR},
      </if>
      <if test="payPassword != null" >
        #{payPassword,jdbcType=VARCHAR},
      </if>
      <if test="withdrawPassword != null" >
        #{withdrawPassword,jdbcType=VARCHAR},
      </if>
      <if test="email != null" >
        #{email,jdbcType=VARCHAR},
      </if>
      <if test="weixinNo != null" >
        #{weixinNo,jdbcType=VARCHAR},
      </if>
      <if test="qqNo != null" >
        #{qqNo,jdbcType=VARCHAR},
      </if>
      <if test="type != null" >
        #{type,jdbcType=VARCHAR},
      </if>
      <if test="identityCardPic1 != null" >
        #{identityCardPic1,jdbcType=INTEGER},
      </if>
      <if test="identityCardPic2 != null" >
        #{identityCardPic2,jdbcType=INTEGER},
      </if>
      <if test="registerType != null" >
        #{registerType,jdbcType=VARCHAR},
      </if>
      <if test="provinceId != null" >
        #{provinceId,jdbcType=INTEGER},
      </if>
      <if test="cityId != null" >
        #{cityId,jdbcType=INTEGER},
      </if>
      <if test="districtId != null" >
        #{districtId,jdbcType=INTEGER},
      </if>
      <if test="townId != null" >
        #{townId,jdbcType=INTEGER},
      </if>
       <if test="birthday != null">
        #{birthday,jdbcType=TIMESTAMP},
      </if>
      <if test="rebatesLevel != null">
        #{rebatesLevel,jdbcType=VARCHAR},
      </if>
    </trim>
  </insert>
  <update id="updatePassword" parameterType="com.idcq.appserver.dto.user.UserDto">
  	update 1dcq_user set password = #{password}, last_update_time = NOW() where mobile = #{mobile}
  </update>
  <update id="updateIsMember" parameterType="java.util.Map">
  	update 1dcq_user set is_member = #{isMember}, last_update_time = NOW() where user_id = #{userId}
  </update>
  <update id="updateMobile" parameterType="com.idcq.appserver.dto.user.UserDto">
  	update 1dcq_user set mobile = #{newMobile}, last_update_time = NOW() where mobile = #{mobile}
  </update>
   <update id="updateWeiXinNo" parameterType="com.idcq.appserver.dto.user.UserDto">
  	update 1dcq_user set weixin_no = #{weixinNo}, status=#{status},last_update_time = NOW() where user_id = #{userId}
  </update>
  
	<update id="updateUser" parameterType="java.util.Map" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Mar 11 10:39:12 CST 2015.
    -->
    update 1dcq_user
    <set>
      <if test="user.userId != null" >
        user_id = #{user.userId,jdbcType=INTEGER},
      </if>
      <if test="user.userType != null" >
        user_type = #{user.userType,jdbcType=TINYINT},
      </if>
      <if test="user.userType2 != null" >
        user_type2 = #{user.userType2,jdbcType=TINYINT},
      </if>
      <if test="user.status != null" >
        status = #{user.status,jdbcType=TINYINT},
      </if>
      <if test="user.statusDesc != null" >
        status_desc = #{user.statusDesc,jdbcType=VARCHAR},
      </if>
      <if test="user.userName != null" >
        username = #{user.userName,jdbcType=VARCHAR},
      </if>
        <if test="user.nikeName != null" >
        nick_name = #{user.nikeName,jdbcType=VARCHAR},
      </if>
      <if test="user.identityCardNo != null" >
        identity_card_no = #{user.identityCardNo,jdbcType=VARCHAR},
      </if>
      <if test="user.mobile != null" >
        mobile = #{user.mobile,jdbcType=VARCHAR},
      </if>
      <if test="user.password != null" >
        password = #{user.password,jdbcType=VARCHAR},
      </if>
      <if test="user.trueName != null" >
        true_name = #{user.trueName,jdbcType=VARCHAR},
      </if>
      <if test="user.referUserId != null" >
        refer_user_id = #{user.referUserId,jdbcType=INTEGER},
      </if>
      <if test="user.referShopId != null" >
        refer_shop_id = #{user.referShopId,jdbcType=INTEGER},
      </if>
      <if test="user.referType != null" >
        refer_type = #{user.referType,jdbcType=INTEGER},
      </if>
      <if test="user.sex != null" >
        sex = #{user.sex,jdbcType=BIT},
      </if>
      <if test="user.createTime != null" >
        create_time = #{user.createTime,jdbcType=TIMESTAMP},
      </if>
      <if test="user.firstLoginTime != null" >
        first_login_time = #{user.firstLoginTime,jdbcType=TIMESTAMP},
      </if>
      <if test="user.lastUpdateTime != null" >
        last_update_time = #{user.lastUpdateTime,jdbcType=TIMESTAMP},
      </if>
      <if test="user.bigLogo != null" >
        big_logo = #{user.bigLogo,jdbcType=VARCHAR},
      </if>
      <if test="user.smallLogo != null" >
        small_logo = #{user.smallLogo,jdbcType=VARCHAR},
      </if>
      <if test="user.payPassword != null" >
        pay_password = #{user.payPassword,jdbcType=VARCHAR},
      </if>
      <if test="user.withdrawPassword != null" >
        withdraw_password = #{user.withdrawPassword,jdbcType=VARCHAR},
      </if>
      <if test="user.email != null" >
        email = #{user.email,jdbcType=VARCHAR},
      </if>
      <if test="user.weixinNo != null" >
        weixin_no = #{user.weixinNo,jdbcType=VARCHAR},
      </if>
      <if test="user.qqNo != null" >
        qq_no = #{user.qqNo,jdbcType=VARCHAR},
      </if>
      <if test="user.type != null" >
        type = #{user.type,jdbcType=VARCHAR},
      </if>
      <if test="user.identityCardPic1 != null" >
         identity_card_pic1 = #{user.identityCardPic1,jdbcType=INTEGER},
      </if>
      <if test="user.identityCardPic2 != null" >
        identity_card_pic2 = #{user.identityCardPic2,jdbcType=INTEGER},
      </if>
      <if test="user.registerType != null" >
        register_type = #{user.registerType,jdbcType=VARCHAR},
      </if>
      <if test="user.provinceId != null" >
        province_id = #{user.provinceId,jdbcType=INTEGER},
      </if>
      <if test="user.cityId != null" >
        city_id = #{user.cityId,jdbcType=INTEGER},
      </if>
      <if test="user.districtId != null" >
        district_id = #{user.districtId,jdbcType=INTEGER},
      </if>
      <if test="user.townId != null" >
        town_id = #{user.townId,jdbcType=INTEGER},
      </if>
      <if test="user.residentTown != null" >
        resident_town = #{user.residentTown,jdbcType=VARCHAR},
      </if>
      <if test="user.birthday != null">
        birthday = #{user.birthday,jdbcType=TIMESTAMP},
      </if>
      <if test="user.isMember != null">
      	is_member = #{user.isMember,jdbcType=INTEGER},
      </if>
      <if test="user.rebatesLevel != null">
        rebates_level = #{user.rebatesLevel,jdbcType=VARCHAR},
      </if>
      <if test="user.isDistributor != null">
        is_distributor = #{user.isDistributor,jdbcType=VARCHAR},
      </if>

      <if test="user.referUserIdOld != null">
        refer_user_id_old = #{user.referUserIdOld},
      </if>

      <if test="user.referAgentNum != null">
        refer_agent_num = refer_agent_num + #{user.referAgentNum},
      </if>
      <if test="user.isGroupLeader != null">
        is_group_leader = #{user.isGroupLeader},
      </if>
      <if test="user.referAgentNum2 != null">
        refer_agent_num2 = refer_agent_num2 + #{user.referAgentNum2},
      </if>
    </set>
    	where user_id = #{user.userId}
  </update>
  
   <update id="updatePayPassword" parameterType="com.idcq.appserver.dto.user.UserDto">
  		update 1dcq_user set pay_password = #{payPassword}, last_update_time = NOW() where user_id = #{userId}
  </update>
  <!-- 实名认证 -->
   <update id="authRealName" parameterType="com.idcq.appserver.dto.user.UserDto">
  		update 
  			1dcq_user
  		set 
  			true_name = #{trueName},
  			identity_card_no = #{identityCardNo}
  		where 
  			user_id = #{userId}
  </update>

  <!-- 查询用户会员卡信息 -->
  <select id="getUserMembershipCardList" resultType="java.util.Map" parameterType="java.util.Map">
		select  
				umc.umc_id as accountId,
				c.card_name as cardName,
				umc.amount as amount,
				umc.card_no as cardNo,
				c.card_logo as cardLogo,
				umc.shop_id as shopId,
				s.shop_name as shopName,
				umc.create_time as createTime
		from 
				1dcq_shop s 
		left join 
				1dcq_shop_membership_card_type c
		on 
				s.shop_id = c.shop_id 
		left join
		    1dcq_user_membership_card umc
		on
		    umc.shop_id = s.shop_id
		 where
				umc.user_id = #{userId} limit #{n},#{m}
  </select> 
    <!-- 查询用户会员卡信息列表总记录数 -->
  <select id="getUserMembershipCardListCount" resultType="int" parameterType="java.util.Map">
		select  
				count(*)
		from 
				1dcq_shop s 
		left join 
				1dcq_shop_membership_card_type c
		on 
				s.shop_id = c.shop_id 
		left join
		    1dcq_user_membership_card umc
		on
		    umc.shop_id = s.shop_id
		where
				umc.user_id = #{userId} 
  </select> 
      <!-- 查询用户会员卡详情-->
  <select id="getUserMembershipCardInfo" resultType="java.util.Map" parameterType="java.lang.Long">
		select  
			c.card_name as cardName,
			umc.card_no as cardNo,
			umc.amount as amount,
		    c.card_logo as cardLogo,
			s.shop_id as shopId,
			s.shop_name as shopName,
			umc.create_time as createTime,
		    s.address as address,
		    s.telephone as telephone
		from 
			1dcq_shop s 
		left join 
			1dcq_shop_membership_card_type c
		on 
			s.shop_id = c.shop_id 
		left join
		    1dcq_user_membership_card umc
		on
		    umc.shop_id = s.shop_id
		 where
				umc.umc_id = #{accountId}
		limit 1
  </select>
  <!-- 插入搜索历史记录 -->
  <insert id="addUserSearchHistory" parameterType="com.idcq.appserver.dto.user.UserSearchHistory" >
    insert into 
	    1dcq_user_search_history (
	    user_id,
	    search_content, 
	    create_time
    )
    values(
	    #{userId,jdbcType=INTEGER},
	    #{searchContent,jdbcType=VARCHAR}, 
	    NOW()
    )
  </insert>
<!--   删除用户历史全部记录 -->
  <delete id="deleteUserSearchHistory" parameterType="com.idcq.appserver.dto.user.UserSearchHistory" >
    delete from 
    	1dcq_user_search_history
    where 
    	user_id = #{userId,jdbcType=INTEGER}
    <if test="searchContent">
    and search_content = #{searchContent,jdbcType=VARCHAR}
    </if>	
  </delete>
  
  <insert id="insertUserSearchHistory">
  	insert into 1dcq_user_search_history(user_id,search_content,create_time)
  	values(#{userId},#{searchContent},#{createTime})
  </insert>
    <!-- 查询用户历史记录列表 -->
  <select id="getSearchHistory" resultType="java.util.Map" parameterType="java.util.Map">
	select
	    search_content as searchContent
	from 
		1dcq_user_search_history ush
	where
  		ush.user_id = #{userId,jdbcType=INTEGER}
	order by 
		create_time DESC limit #{n},#{m} 
  </select>    
    <!-- 查询用户历史记录列表总记录数 -->
  <select id="getSearchHistoryCount" resultType="int" parameterType="java.lang.Long">
	select
		count(*)
	from 
		1dcq_user_search_history ush
	where
  		ush.user_id = #{userId,jdbcType=INTEGER}
  </select>        
  
  <!-- 保存用户推荐信息 -->
  <insert id="isnertUserReferInfo" parameterType="java.util.Map">
  	insert into 1dcq_user_refer(user_id,refer_mobile,refer_code,create_time) values(#{userId},#{referMobile},#{referCode},#{createTime})
  </insert>
  <!-- 推荐码验证 where refer_mobile = #{referMobile} and refer_code = #{referCode}-->
  <select id="queryUserReferInfo" parameterType="java.util.Map" resultType="java.lang.Integer">
  	select count(1) from 1dcq_user_refer 
  	<where>
  		<if test="referMobile != null">
  			and refer_mobile = #{referMobile}
  		</if>
  		<if test="referCode != null">
  			and refer_code = #{referCode}
  		</if>
  	</where> 
  	LIMIT 1
  </select>
  <select id="queryUserReferCode" parameterType="java.util.Map" resultType="java.util.Map">
  	SELECT
		t.refer_id,
		t.user_id,
		t.refer_code,
		t.refer_mobile
	FROM
		1dcq_user_refer t
	WHERE
		t.user_id = #{userId}
	AND t.refer_mobile = #{referMobile}
	LIMIT 1
  </select>
  <update id="updateUserReferCode" parameterType="java.util.Map">
  	UPDATE 1dcq_user_refer t
		SET t.refer_code = #{refer_code},
		 t.create_time = #{create_time}
		WHERE
			t.refer_id = #{refer_id}
  </update>
  <!-- 更新用户头像 -->
  <update id="updateUserLogo" parameterType="java.util.Map">
     update 1dcq_user 
     <set >
      <if test="usageType == 11" >
         small_logo  = #{url,jdbcType=VARCHAR},
      </if>
      <if test="usageType == 12 " >
         big_logo = #{url,jdbcType=VARCHAR},
      </if>
      last_update_time = NOW()
    </set>
    where user_id = #{userId}
  </update>
  
     <!-- 查询用户历史记录列表 -->
  <select id="getMyRefUsers" resultType="java.util.Map" parameterType="java.util.Map">
	select
	    u.mobile as mobile, 
	    u.create_time  as refDate
	from 
		1dcq_user u
	where
  		u.refer_user_id = #{userId,jdbcType=INTEGER}
  	and u.refer_type = 0
	order by 
		u.create_time DESC, u.mobile  limit #{n},#{m} 
  </select>    
    <!-- 查询用户历史记录列表总记录数 -->
  <select id="getMyRefUsersCount" resultType="int" parameterType="java.lang.Long">
	select
		count(1)
	from 
		1dcq_user u
	where
  		u.refer_user_id = #{userId,jdbcType=INTEGER}
  	and u.refer_type = 0
  </select> 
  
  <select id="sumAmount" resultType="java.lang.Double" parameterType="java.util.Map">
  select ifnull(sum(money),0) from 1dcq_user_bill WHERE consumer_mobile = #{mobile} and bill_status = #{billStatus} and bill_type = #{billType}  and user_id = #{userId}
  </select>
  
    <select id="getReferUserBy" resultMap="BaseResultMap" parameterType="java.util.Map">
	select
	     u.mobile,
         u.user_id
	from 
		 1dcq_user_refer r 
    inner join 1dcq_user u 
    on    r.user_id = u.user_id 
	where
  		r.refer_mobile = #{mobile,jdbcType=VARCHAR}
    and r.refer_code = #{refecode,jdbcType=VARCHAR}
  	order by 
		r.create_time DESC
  </select>
  
  <select id="getCountByUserIdAndSearchContent"  resultType="java.lang.Integer">
  		select count(1) from 1dcq_user_search_history 
  		where user_id=#{userId}
  		and search_content=#{searchContent}
  </select>     
  
   <update id="updateUserStatus" parameterType="java.util.Map">
  	UPDATE 1dcq_user t
		SET t.status = #{status},
		 	t.first_login_time = #{firstLoginTime},
		 	t.last_update_time = NOW(),
		 	t.last_login_time = NOW(),
		 	t.is_member = #{isMember}
		WHERE
			t.mobile = #{mobile}
  </update>    
  <update id="updateUserMac" parameterType="java.util.Map">
  	UPDATE 1dcq_user t
		SET t.user_mac = #{sn},
		 	t.last_update_time = NOW(),
		 	t.last_login_time = NOW(),
		 	t.first_login_time = #{firstLoginTime},
		 	t.is_member = #{isMember}
		WHERE
			t.mobile = #{mobile}
  </update>   
    <update id="updateUserLastLoginTime" parameterType="java.util.Map">
  	UPDATE 1dcq_user t
	   SET t.last_login_time = #{lastLoginTime},
	       t.first_login_time = #{firstLoginTime},
	       t.is_member = #{isMember}
     WHERE t.mobile = #{mobile}
  </update>   
  
  <update id="addUserAmount">
  	UPDATE 1dcq_user_account
	SET amount=amount+IFNULL(#price#,0)
	WHERE user_id=#userId# AND account_status=1
  </update>
  
  <update id="updateUserSearchHistory" parameterType="com.idcq.appserver.dto.user.UserSearchHistory">
  	update 1dcq_user_search_history set create_time=NOW() WHERE user_id=#{userId} and search_content=#{searchContent}
  </update>
  
  <update id="updateUserCardNo" parameterType="java.util.Map">
  	update 1dcq_user set last_update_time=NOW(),identity_card_no=#{identityCardNo} WHERE user_id=#{userId}
  </update>
  
  <!-- 查询用户消费金账单 -->
  <select id="getUserXbill" parameterType="java.util.Map" resultType="java.util.Map">
  		SELECT 
  			ux.xbill_id as billId,
			ux.bill_type as billType,
			ux.money as money,
			ux.create_time as createTime,
            DATE_FORMAT(ux.create_time, '%Y-%m') as billMonth,
			ux.bill_title as billTitle
  		FROM 
  			1dcq_user_xbill ux
  		WHERE 
  			ux.user_id=#{userId}
  	   <if test="uccId != null">
  			and	ux.ucc_id = #{uccId}
  		</if>	
  		<if test="billType != null">
  			and ux.bill_type = #{billType}
  		</if>
  		<if test="startTime != null">
  			and ux.create_time &gt;= #{startTime}
  		</if>
  		<if test="endTime != null">
  			and ux.create_time &lt;= #{endTime}
  		</if>
  		order by 
  			ux.create_time DESC
  		limit #{n},#{m} 
  		
  </select>
  
    <!-- 查询会员账单统计 -->
  <select id="getBillStat" parameterType="java.util.Map" resultType="java.util.Map">
   	SELECT 
			bill.user_bill_type AS moneyType,
			bill.money AS money,
			<if test="areaId == null">
	  			CASE WHEN bill.user_bill_type = 8 AND agent.agent_type = 31 THEN agent.city_id
				     WHEN bill.user_bill_type = 9 AND agent.agent_type = 32 THEN agent.district_id
				     WHEN bill.user_bill_type = 10 AND agent.agent_type = 33 THEN agent.town_id END AS areaId ,
			     
				CASE WHEN bill.user_bill_type = 8 AND agent.agent_type = 31 THEN fc_1dcq_get_cityname_by_cityid(agent.city_id) 
				     WHEN bill.user_bill_type = 9 AND agent.agent_type = 32 THEN fc_1dcq_get_districtname_by_districtid(agent.district_id) 
				     WHEN bill.user_bill_type = 10 AND agent.agent_type = 33 THEN fc_1dcq_get_townname_by_townid(agent.town_id) END AS areaName
  			</if>
			<if test="areaId != null">
				CASE WHEN bill.user_bill_type = 8 AND agent.agent_type = 31 THEN fc_1dcq_get_cityname_by_cityid(#{areaId}) 
				     WHEN bill.user_bill_type = 9 AND agent.agent_type = 32 THEN fc_1dcq_get_districtname_by_districtid(#{areaId}) 
				     WHEN bill.user_bill_type = 10 AND agent.agent_type = 33 THEN fc_1dcq_get_townname_by_townid(#{areaId}) END AS areaName
  			</if>
  		FROM 
  			1dcq_user_bill AS bill 
  		LEFT JOIN 
              1dcq_agent AS agent
		ON
			bill.user_id = agent.user_id
		AND
			bill.agent_id = agent.agent_id
  		WHERE 
  			bill.user_id=#{userId}
  		    and bill.create_time &gt;= #{startTime}
  		<if test="endTime != null">
  			and bill.create_time &lt;= #{endTime}
  		</if>
  		<if test="moneyType != null">
  			and bill.user_bill_type IN 
  			 <foreach collection="moneyType" item="billType" open="(" separator="," close=")">
     				#{billType}
     		</foreach>
  		</if>
  		<if test="accountType != null">
  			and bill.account_type IN 
  			 <foreach collection="accountType" item="account" open="(" separator="," close=")">
     				#{account}
     		</foreach>
  		</if>
  		<if test="isShow != null">
			and is_show = #{isShow}
		</if>
  </select>
  
  <!-- 查询会员账单明细 -->
  <select id="getBillDetail" parameterType="java.util.Map" resultType="java.util.Map">
   	SELECT 
 			bill.bill_id AS billId,
 			bill.transaction_id AS transactionId,
 			bill.red_packet_id AS redPacketId,
  			DATE_FORMAT(bill.create_time, '%Y-%m-%d %H:%i:%s') AS billTime,
			bill.order_id AS orderId,
			bill.bill_title AS descript,
			bill.user_bill_type AS moneyType,
			bill.money AS money,
			bill.account_after_amount AS balance,
			bill.account_type AS accountType,
			<if test="areaId == null">
	  			CASE WHEN bill.user_bill_type = 8 AND agent.agent_type = 31 THEN agent.city_id
				     WHEN bill.user_bill_type = 9 AND agent.agent_type = 32 THEN agent.district_id
				     WHEN bill.user_bill_type = 10 AND agent.agent_type = 33 THEN agent.town_id END AS areaId ,
			     
				CASE WHEN bill.user_bill_type = 8 AND agent.agent_type = 31 THEN fc_1dcq_get_cityname_by_cityid(agent.city_id) 
				     WHEN bill.user_bill_type = 9 AND agent.agent_type = 32 THEN fc_1dcq_get_districtname_by_districtid(agent.district_id) 
				     WHEN bill.user_bill_type = 10 AND agent.agent_type = 33 THEN fc_1dcq_get_townname_by_townid(agent.town_id) END AS areaName
  			</if>
			<if test="areaId != null">
				CASE WHEN bill.user_bill_type = 8 AND agent.agent_type = 31 THEN fc_1dcq_get_cityname_by_cityid(#{areaId}) 
				     WHEN bill.user_bill_type = 9 AND agent.agent_type = 32 THEN fc_1dcq_get_districtname_by_districtid(#{areaId}) 
				     WHEN bill.user_bill_type = 10 AND agent.agent_type = 33 THEN fc_1dcq_get_townname_by_townid(#{areaId}) END AS areaName
  			</if>
  		FROM 
  			1dcq_user_bill AS bill 
  		LEFT JOIN 
			1dcq_agent AS agent
		ON
			bill.user_id = agent.user_id
	 	AND
			bill.agent_id = agent.agent_id  
  		WHERE 
  			bill.user_id=#{userId}
  		    and bill.create_time &gt;= #{startTime}
  		<if test="endTime != null">
  			and bill.create_time &lt;= #{endTime}
  		</if>
  		<if test="moneyType != null">
  			and bill.user_bill_type IN 
  			 <foreach collection="moneyType" item="billType" open="(" separator="," close=")">
     				#{billType}
     		</foreach>
  		</if>
  		<if test="accountType != null">
  			and bill.account_type IN 
  			 <foreach collection="accountType" item="account" open="(" separator="," close=")">
     				#{account}
     		</foreach>
  		</if>
  		<if test="isShow != null">
			and is_show = #{isShow}
		</if>
  		order by 
  			bill.create_time DESC
  		limit #{pageNum},#{pageSize} 
  </select>
  
   <select id="getBillDetailCount" parameterType="java.util.Map" resultType="java.lang.Integer">
   	SELECT COUNT(1)
  		FROM 
  			1dcq_user_bill AS bill 
  		LEFT JOIN 
			1dcq_agent AS agent
		ON
			bill.user_id = agent.user_id
	 	AND
			bill.agent_id = agent.agent_id  
  		WHERE 
  			bill.user_id=#{userId}
  		    and bill.create_time &gt;= #{startTime}
  		<if test="endTime != null">
  			and bill.create_time &lt;= #{endTime}
  		</if>
  		<if test="moneyType != null">
  			and bill.user_bill_type IN 
  			 <foreach collection="moneyType" item="billType" open="(" separator="," close=")">
     				#{billType}
     		</foreach>
  		</if>
  		<if test="accountType != null">
  			and bill.account_type IN 
  			 <foreach collection="accountType" item="account" open="(" separator="," close=")">
     				#{account}
     		</foreach>
  		</if>
  		<if test="isShow != null">
			and is_show = #{isShow}
		</if>
  </select>
  
  <!-- 查询用户消费金账单 -->
  <select id="getUserXbillCount" parameterType="java.util.Map" resultType="java.lang.Integer">
  		SELECT 
  			count(*)
  		FROM 
  			1dcq_user_xbill 
  		WHERE 
  			user_id=#{userId}
  		<if test="billType!=null">
  			and bill_type = #{billType}
  		</if>
  		<if test="startTime!=null">
  			and create_time &gt;= #{startTime}
  		</if>
  		<if test="endTime!=null">
  			and create_time &lt;= #{endTime}
  		</if>
  </select>
  <select id="getUserVantagesByUserIdAndShopId" resultType="java.math.BigDecimal" parameterType="java.util.Map">
  		SELECT 
  			vantages
  		FROM 
  			1dcq_shop_user_vantages 
  		WHERE 
  			user_id = #{userId}
  		AND
  			shop_id = #{shopId}
  		LIMIT 1
  </select>
  
<!--   插入会员积分 -->
  <insert id="insertShopUserVantages" parameterType="com.idcq.appserver.dto.user.ShopUserVantages">
  	    INSERT INTO
  	    	1dcq_shop_user_vantages
  	    (
  	    	shop_id,
  	    	user_id,
  	    	vantages,
  	    	create_time,
  	    	last_update_time
  	    )
  	    VALUES
  	    (
  	    	#{shopId},
  	    	#{userId},
  	    	#{vantages},
  	    	#{createTime},
  	    	#{lastUpdateTime}
		)
  	    	
  </insert>
<!--   更新会员积分 -->
  <update id="updateShopUserVantages" parameterType="com.idcq.appserver.dto.user.ShopUserVantages">
  	    UPDATE
  	    	1dcq_shop_user_vantages
  	    SET 
  	    	shop_id = #{shopId},
  	    	user_id = #{userId},
  	    	vantages = #{vantages},
  	    	create_time = #{createTime},
  	    	last_update_time = #{lastUpdateTime}
  		WHERE 
  			user_id = #{userId}
  		AND
  			shop_id = #{shopId}
  	    	
  </update>
<!--   记录会员积分日志 -->
  <insert id="insertShopUserVantagesLog" parameterType="com.idcq.appserver.dto.user.ShopUserVantages">
  	    INSERT INTO
  	    	1dcq_shop_user_vantages_log
  	    (
  	    	shop_id,
  	    	user_id,
  	    	order_id,
            exchange_money,
            money_to_vantages,
            exchange_vantages,
  	    	create_time,
  	    	last_update_time
  	    )
  	    VALUES
  	    (
  	    	#{shopId},
  	    	#{userId},
  	    	#{orderId},
  	    	#{exchangeMoney},
  	    	#{moneyToVantages},
  	    	#{exchangeVantages},
  	    	#{createTime},
  	    	#{lastUpdateTime}
		)
  	    	
  </insert>
<!--   查询归属地为null的用户信息 -->
  <select id="getUserInfoByProvinceIdIsNull" parameterType="java.util.Map" resultType="java.util.Map">
  	select 
	  	user_id as userId,
	  	mobile as mobile
  	from
  	   1dcq_user
  	where
  		province_id is null
  	limit #{limit},#{pNo}
  </select>
<!--   更新用户归属地 -->
  <update id="updateUserPlace" parameterType="java.util.Map">
  	    UPDATE
  	    	1dcq_user
  	    SET 
  	    	province_id = #{provinceId},
            city_id = #{cityId}
  		WHERE 
  			user_id = #{userId}
  </update>
  
  <!-- 更新用户身份证信息 -->
  <update id="updateIdentity" parameterType="java.util.Map">
      update
      	1dcq_user
      set
      	identity_card_pic1=#{card1},
      	identity_card_pic2=#{card2},
      	<if test="identityCardNo != null">
      		identity_card_no = #{identityCardNo}
      	</if>
      where
      	user_id = #{userId}
  </update>
  
  <!--  线上数据临时： 查询归属地为null的用户信息 -->
  <select id="getNoCityMobile" parameterType="java.util.Map" resultType="java.util.Map">
  	select 
	  	mobile as mobile
  	from
  	   no_city_mobile
  	where
  	   city_name is null
  	limit #{limit},#{pNo}
  </select>
  <!--线上数据临时：更新用户归属地 -->
  <update id="updateNoCityMobile" parameterType="java.util.Map">
  	    UPDATE
  	    	no_city_mobile
  	    SET 
            city_name = #{cityName}
  		WHERE 
  			mobile = #{mobile}
  </update>
  
  <!-- 更新用户为管理者 -->
  <update id="updateUserIsManager" parameterType="java.lang.Long">
  	    UPDATE
  	    	1dcq_user 
  	    SET 
            is_shop_maneger = 1 
  		WHERE 
  			user_id = #{userId}
  </update>
  
  <!-- U43：我的推荐用户列表接口 2015.12.3 add by huangrui -->
  <select id="getMyRefUserList" resultType="java.util.Map" parameterType="java.util.Map" >
   SELECT 
  		user_id AS recommendedUserId,
  		username AS recommendedUserName,
  		mobile AS recommendedUserTel,
		register_type AS recommendWay,
		create_time AS recommendTime 
	FROM
  		1dcq_user 
	WHERE refer_user_id = #{userId}
	 ORDER BY create_time desc, mobile limit #{n},#{m}
  </select>
   <!-- U43：我的推荐用户列表接口 2015.12.3 add by huangrui -->
  <select id="getMyRefUserListCount" resultType="Integer" parameterType="java.util.Map" >
   SELECT 
  		count(1)
	FROM
  		1dcq_user 
	WHERE refer_user_id = #{userId}
  </select>
  
   <!-- PCS22：我的推荐用户列表接口 2015.12.3 add by huangrui -->
  <select id="getTotalMember" resultType="Integer" parameterType="java.util.Map" >
	   SELECT 
	  		count(1)
		FROM
	  		1dcq_user 
		WHERE refer_user_id = #{userId}
  </select>
  
  <select id="queryUserByIdList" resultMap="BaseResultMap" parameterType="java.util.Map">
  		select * from 1dcq_user u where
  		user_id in
  		<foreach collection="userIdList" open="(" close=")" separator="," item="item">
  			#{item}
  		</foreach>
  
  </select>
  
   <select id="getUserByMap" resultMap="BaseResultMap" parameterType="java.util.Map" >
    select
    <include refid="Base_Column_List" />
    from 1dcq_user
    <where>
    	<if test="mobile != null">
    		and mobile = #{mobile}
    	</if>
    	<if test="isMember != null">
    		and is_member = #{isMember}
    	</if>
    </where>
  </select>
  
   <select id="getShopPrincipalInfoByShopId" resultMap="BaseResultMap" parameterType="java.util.Map" >
    select
	    u.user_id, 
	    u.user_type, 
	    u.user_type2, 
	    u.is_member,
	    u.status, 
	    u.status_desc, 
	    u.userName,
	    u.nick_name,
	    u.identity_card_no, 
	    u.mobile, 
	    u.password, 
	    u.true_name, 
	    u.refer_user_id, 
	    u.refer_shop_id, 
	    u.refer_type, 
	    u.sex, 
	    u.create_time, 
	    u.first_login_time, 
	    u.last_update_time, 
	    u.big_logo, 
	    u.small_logo, 
	    u.pay_password,
	    u.withdraw_password, 
	    u.email, 
	    u.weixin_no, 
	    u.qq_no,
	    u.identity_card_pic1,
	    u.identity_card_pic2,
	    u.register_type, 
	    u.province_id,
	    u.city_id,
	    u.district_id,
	    u.town_id,
	    u.resident_town,
	    u.birthday,
	    u.user_mac,
	    u.last_login_time
    from 1dcq_user u
    inner join 1dcq_shop s on s.principal_id = u.user_id
    <where>
    	<if test="shopId != null">
    		s.shop_id = #{shopId}
    	</if>
    </where>
  </select>
</mapper>